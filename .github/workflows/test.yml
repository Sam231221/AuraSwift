# Test Workflow for AuraSwift
#
# Runs all test suites (Unit, Component, Integration, E2E) on PRs and pushes.
# This workflow is optimized for fast feedback and cost efficiency.
#
# Best Practices:
# - Runs on PRs for early feedback
# - Uses caching for dependencies
# - Parallel jobs for faster execution
# - Conditional test execution based on changes
# - Cost optimization with path filters

name: Tests

on:
  # Run on pull requests for early feedback
  pull_request:
    paths:
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"
      - "tests/**"
      - "packages/**"
      - "package.json"
      - "package-lock.json"
      - "vitest.config.ts"
      - "playwright.config.ts"
      - ".github/workflows/test.yml"
    paths-ignore:
      - "**.md"
      - ".editorconfig"
      - ".idea/**"
      - ".vscode/**"
      - ".github/docs/**"

  # Run on pushes to main for continuous integration
  push:
    branches:
      - main
    paths:
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"
      - "tests/**"
      - "packages/**"
      - "package.json"
      - "package-lock.json"
      - "vitest.config.ts"
      - "playwright.config.ts"
      - ".github/workflows/test.yml"
    paths-ignore:
      - "**.md"
      - ".editorconfig"
      - ".idea/**"
      - ".vscode/**"
      - ".github/docs/**"

  # Allow manual triggering
  workflow_dispatch:

  # Allow being called from other workflows
  workflow_call:
    inputs:
      skip-e2e:
        description: "Skip E2E tests (faster, for PR checks)"
        required: false
        type: boolean
        default: false
      skip-unit:
        description: "Skip unit/component/integration tests"
        required: false
        type: boolean
        default: false

# Concurrency control to cancel in-progress runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions
permissions:
  contents: read
  pull-requests: write

env:
  NODE_NO_WARNINGS: 1
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  ELECTRON_SKIP_BINARY_DOWNLOAD: 1
  ELECTRON_DISABLE_GPU: 1
  ELECTRON_NO_SANDBOX: 1
  CI: true
  NODE_ENV: test

jobs:
  # Job 1: Unit, Component, and Integration Tests (Vitest)
  # Runs on Linux for speed and cost efficiency
  vitest-tests:
    name: Unit, Component & Integration Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-unit }}
    strategy:
      fail-fast: false
      matrix:
        test-type:
          - unit
          - components
          - integration

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: test-deps-${{ runner.os }}-node22-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            test-deps-${{ runner.os }}-node22-

      - name: Install dependencies (lightweight, no native builds)
        run: npm ci --prefer-offline --no-audit --no-fund --ignore-scripts
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          PUPPETEER_SKIP_DOWNLOAD: 1

      - name: Run ${{ matrix.test-type }} tests
        run: |
          case "${{ matrix.test-type }}" in
            unit)
              npm run test:unit
              ;;
            components)
              npm run test:components
              ;;
            integration)
              npm run test:integration
              ;;
          esac

      - name: Upload coverage reports
        if: matrix.test-type == 'unit'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.test-type }}
          path: coverage/
          retention-days: 7
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            test-results/
            coverage/
          retention-days: 3
        continue-on-error: true

  # Job 2: E2E Tests (Playwright)
  # Runs on Windows to match production environment
  # Runs on main branch, manual trigger, or when called from compile-and-test.yml
  # Skips on PRs for cost optimization (PRs get fast unit/component/integration tests)
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: windows-2022
    if: ${{ !inputs.skip-e2e && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') }}
    needs: [] # Run independently for faster feedback

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Setup MSBuild (Windows)
        uses: microsoft/setup-msbuild@v2

      - name: Setup Python for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: e2e-deps-${{ runner.os }}-node22-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            e2e-deps-${{ runner.os }}-node22-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 0

      # Only build if dist doesn't exist (when called from compile-and-test.yml, build already exists)
      - name: Check if build exists
        id: check-build
        run: |
          if (Test-Path "dist/win-unpacked/auraswift.exe" -or Test-Path "dist/win-unpacked/AuraSwift.exe") {
            echo "build-exists=true" >> $env:GITHUB_OUTPUT
            Write-Host "Build already exists, skipping build step"
          } else {
            echo "build-exists=false" >> $env:GITHUB_OUTPUT
            Write-Host "Build not found, will build application"
          }
        shell: powershell

      - name: Build application (required for E2E tests if not already built)
        if: steps.check-build.outputs.build-exists != 'true'
        run: npm run build
        env:
          NODE_ENV: production
          VITE_DISTRIBUTION_CHANNEL: test

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          NODE_ENV: test
          ELECTRON_DISABLE_GPU: 1
          ELECTRON_NO_SANDBOX: 1
          PLAYWRIGHT_HEADLESS: 1
          ELECTRON_ENABLE_LOGGING: 1
          HARDWARE_SIMULATION_MODE: true
          MOCK_PRINTER_ENABLED: true
          MOCK_CARD_READER_ENABLED: true
          MOCK_SCANNER_ENABLED: true
          ELECTRON_UPDATER_DISABLED: 1

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Upload E2E screenshots and videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-artifacts
          path: test-results/artifacts/
          retention-days: 7

  # Job 3: Test Summary and Status
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - vitest-tests
      - e2e-tests
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.vitest-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Component Tests | ${{ needs.vitest-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.vitest-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.e2e-tests.result }}" != "skipped" ]; then
            echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && '✅ Passed' || needs.e2e-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests | ⏭️ Skipped (run on main branch or manual trigger) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any tests failed
        if: needs.vitest-tests.result != 'success' || (needs.e2e-tests.result != 'success' && needs.e2e-tests.result != 'skipped')
        run: |
          echo "One or more test suites failed"
          exit 1

name: Setup Electron Template with Renderer
description: Initialize the Electron template with renderer package and dependencies

inputs:
  renderer-template:
    description: Define what vite template should be used to create renderer in case if renderer package doesn't exist
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v4
      with:
        node-version: "22.x"
        # Disable setup-node cache to avoid stale node_modules from different Node versions
        cache: ""

    - name: Check if renderer directory exists
      id: check-renderer
      run: >-
        if [ -d "packages/renderer" ]; then
          echo "RENDERER_EXIST=true" >> $GITHUB_OUTPUT
        else
          echo "RENDERER_EXIST=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - run: |
        npm run create-renderer -- -- --template ${{inputs.renderer-template}}
        npm start --workspace @app/integrate-renderer
      shell: bash
      if: inputs.renderer-template != '' && steps.check-renderer.outputs.RENDERER_EXIST == 'false'

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: node_modules
        key: npm-${{ runner.os }}-node22-${{ inputs.renderer-template }}-${{ hashFiles('**/package.json') }}
        restore-keys: |
          npm-${{ runner.os }}-node22-${{ inputs.renderer-template }}-

    - name: Clean workspace (remove incompatible node_modules only)
      run: |
        echo "Cleaning npm cache..."
        npm cache clean --force || true
        echo "Removing node_modules directories with retry logic..."
        echo "NOTE: Only removing node_modules, NOT package directories"
        # Retry removal with delays to handle locked files on Windows
        for i in 1 2 3; do
          # Only remove node_modules directories, not the packages themselves
          rm -rf node_modules 2>/dev/null || true
          rm -rf packages/*/node_modules 2>/dev/null || true
          sleep 1
        done
        # Force remove any remaining locked node_modules (Windows-specific)
        if [ "$RUNNER_OS" = "Windows" ]; then
          echo "Windows detected - using PowerShell for force removal of node_modules only"
          # Only remove node_modules directories, preserve package.json files
          powershell -Command "
            if (Test-Path 'node_modules') { Remove-Item -Path 'node_modules' -Recurse -Force -ErrorAction SilentlyContinue }
            Get-ChildItem -Path 'packages' -Directory -ErrorAction SilentlyContinue | ForEach-Object {
              \$nodeModulesPath = Join-Path \$_.FullName 'node_modules'
              if (Test-Path \$nodeModulesPath) {
                Remove-Item -Path \$nodeModulesPath -Recurse -Force -ErrorAction SilentlyContinue
              }
            }
          " || true
        fi
        echo "Cleanup complete - package.json files preserved"
      shell: bash

    - name: Install Dependencies (skip scripts to avoid conflicts)
      run: |
        set -e
        if [ "${{ steps.check-renderer.outputs.RENDERER_EXIST }}" == "true" ] && [ -f "package-lock.json" ]; then
          echo "Using npm ci for existing project (skipping scripts)..."
          npm ci --prefer-offline --no-audit --progress=false --ignore-scripts
        else
          echo "Using npm install for new project (skipping scripts)..."
          npm install --prefer-offline --no-audit --progress=false --ignore-scripts
        fi
        echo "Dependencies installed. Native modules will be rebuilt separately."
      shell: bash
      env:
        PYTHON: python
        msvs_version: 2022
